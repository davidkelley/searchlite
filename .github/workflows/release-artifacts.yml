name: Release Artifacts

on:
  release:
    types: [published]

permissions:
  contents: write

env:
  DIST_DIR: dist

jobs:
  build-cli:
    name: CLI ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            archive: tar.gz
            ext: ""
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            archive: tar.gz
            ext: ""
            install: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu
          - os: macos-15-intel
            target: x86_64-apple-darwin
            archive: tar.gz
            ext: ""
          - os: macos-15
            target: aarch64-apple-darwin
            archive: tar.gz
            ext: ""
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            archive: zip
            ext: .exe
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            archive: zip
            ext: .exe

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.92.0
          targets: ${{ matrix.target }}

      - name: Install target dependencies
        if: ${{ matrix.install != '' }}
        run: ${{ matrix.install }}

      - name: Build CLI
        run: cargo build --release --bin searchlite-cli --target ${{ matrix.target }}
        env:
          CC_aarch64_unknown_linux_gnu: ${{ matrix.target == 'aarch64-unknown-linux-gnu' && 'aarch64-linux-gnu-gcc' || '' }}

      - name: Package CLI
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$DIST_DIR"
          repo_root="$PWD"
          bin="target/${{ matrix.target }}/release/searchlite-cli${{ matrix.ext }}"
          name="searchlite-cli-${{ matrix.target }}"
          if [ "${{ matrix.archive }}" = "zip" ]; then
            export NAME="$name"
            python -c "import os, zipfile; dist=os.environ['DIST_DIR']; target=os.environ['NAME']; bin_path=os.path.join('target','${{ matrix.target }}','release','searchlite-cli${{ matrix.ext }}'); z=zipfile.ZipFile(os.path.join(dist,f'{target}.zip'),'w',compression=zipfile.ZIP_DEFLATED); z.write(bin_path, arcname=os.path.basename(bin_path)); z.write('LICENSE', arcname='LICENSE'); z.write('README.md', arcname='README.md'); z.close()"
          else
            tar -czf "$DIST_DIR/${name}.tar.gz" \
              -C "$(dirname "$bin")" "$(basename "$bin")" \
              -C "$repo_root" LICENSE README.md
          fi

      - name: Upload CLI asset
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.DIST_DIR }}/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-wasm:
    name: WASM bundle
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.92.0

      - name: Install wasm-pack
        run: cargo install wasm-pack

      - name: Build wasm package
        run: wasm-pack build --release searchlite-wasm

      - name: Package wasm bundle
        run: |
          set -euo pipefail
          mkdir -p "$DIST_DIR"
          cd searchlite-wasm/pkg
          zip -r "../../$DIST_DIR/searchlite-wasm.zip" .

      - name: Upload wasm asset
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.DIST_DIR }}/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
